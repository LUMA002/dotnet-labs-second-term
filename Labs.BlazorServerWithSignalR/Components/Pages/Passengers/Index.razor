@page "/passengers"
@using Labs.BlazorServerWithSignalR.Models
@inject IPassengerService PassengerService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Passengers</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><i class="bi bi-people"></i> Passengers</h1>
        <a href="/passengers/create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Passenger
        </a>
    </div>

    @if (passengers is null)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (!passengers.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No passengers found.
        </div>
    }
    else
    {
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var p in passengers)
                        {
                            var highlight = newPassengersHighlight.Contains(p.PassengerId) ? "table-success" : "";
                            <tr class="@highlight" data-id="@p.PassengerId">
                                <td>
                                    <i class="bi bi-person-circle"></i>
                                    @p.LastName @p.FirstName @p.MiddleName
                                </td>
                                <td>@(string.IsNullOrEmpty(p.PhoneNumber) ? "N/A" : p.PhoneNumber)</td>
                                <td>@(string.IsNullOrEmpty(p.Address) ? "N/A" : p.Address)</td>
                                <td class="text-end">
                                    <div class="btn-group">
                                        <a href="/passengers/details/@p.PassengerId" class="btn btn-sm btn-info"><i class="bi bi-eye"></i></a>
                                        <a href="/passengers/edit/@p.PassengerId" class="btn btn-sm btn-warning"><i class="bi bi-pencil"></i></a>
                                        <a href="/passengers/delete/@p.PassengerId" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {

    // work with ViewModel to allow mutable updates
    private List<UpdatePassengerViewModel>? passengers;
    private HashSet<Guid> newPassengersHighlight = new();
    private DotNetObjectReference<Index>? _ref;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllAsync();
    }

    // with that approach MS.SignalR.Client should also work, I guess
    // so main problem was with not using this method, I guess...
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _ref = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("passengers.register", _ref);
        }
    }

    private async Task LoadAllAsync()
    {
        var list = await PassengerService.GetAllPassengersAsync();
        passengers = list.Select(UpdatePassengerViewModel.FromDto)
                         .OrderBy(p => p.LastName)
                         .ThenBy(p => p.FirstName)
                         .ToList();
    }

    // JSInvokable methods for incremental updates (receive DTO, map to VM)

    [JSInvokable]
    public void AddPassenger(PassengerResponseDto dto)
    {
        if (passengers is null) return;
        if (passengers.Any(p => p.PassengerId == dto.Id)) return; // dublicate check

        var vm = UpdatePassengerViewModel.FromDto(dto);
        passengers.Add(vm);
        passengers = passengers.OrderBy(p => p.LastName).ThenBy(p => p.FirstName).ToList();

        newPassengersHighlight.Add(vm.PassengerId);
        StateHasChanged();
        _ = RemoveHighlightDelayed(vm.PassengerId);
    }

    [JSInvokable]
    public void UpdatePassenger(PassengerResponseDto? dto)
    {
        if (dto is null || passengers is null) return;

        var vm = passengers.FirstOrDefault(p => p.PassengerId == dto.Id);
        if (vm is null)
        {
            AddPassenger(dto);
            return;
        }

        vm.FirstName = dto.FirstName;
        vm.LastName = dto.LastName;
        vm.MiddleName = dto.MiddleName;
        vm.Address = dto.Address;
        vm.PhoneNumber = dto.PhoneNumber;

        StateHasChanged();
    }

    [JSInvokable]
    public void RemovePassenger(Guid id)
    {
        if (passengers is null) return;
        var idx = passengers.FindIndex(p => p.PassengerId == id);
        if (idx >= 0)
        {
            passengers.RemoveAt(idx);
            newPassengersHighlight.Remove(id);
            StateHasChanged();
        }
    }

    private async Task RemoveHighlightDelayed(Guid id)
    {
        await Task.Delay(4000);
        if (newPassengersHighlight.Remove(id))
            StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_ref is not null)
        {
            await JS.InvokeVoidAsync("passengers.unregister");
            _ref.Dispose();
        }
    }
}